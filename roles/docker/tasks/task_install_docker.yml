---
# Tasks to install Docker
- block:
  - name: get the Linux distribution
    ansible.builtin.setup:
      filter:
        - 'ansible_distribution'
  - block:
    - name: Install Podman-Docker
      ansible.builtin.yum:
        name: 'podman-docker'
        state: installed
      when: ansible_facts.distribution == 'AlmaLinux'
    - name: create the /etc/containers/nodocker file
      ansible.builtin.file:
        path: /etc/containers/nodocker
        state: touch
    - name: set ignore_chown_errors to true in /etc/containers/storage.conf
      ansible.builtin.replace:
        path: /etc/containers/storage.conf
        regexp: '^(ignore_chown_errors =) "false"$'
        replace: '\g<1> "true"'
    when: ansible_facts.distribution == 'AlmaLinux'
    become: true
  - name: Install Docker
    ansible.builtin.yum:
      name: 'docker'
      state: installed
    notify:
      - create docker group
      - add user to docker group
      - create docker service directory
      - add proxy to docker
      - start docker
      - reboot the node
    when: ansible_facts.distribution == 'CentOS'
    become: true
  - name: Install Podman-Docker
    ansible.builtin.apt:
      name: 'podman-docker'
      state: present
      update_cache: true
    when: ansible_facts.distribution == 'Ubuntu'
    become: true
  tags: [ 'never', 'docker' ]
